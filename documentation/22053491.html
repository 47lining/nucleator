<!DOCTYPE html>
<html>
  <head>
    <title>Nucleator: Include Additional Customers, Accounts and Cages in your siteconfig</title>
    <link rel="stylesheet" href="../css/site.css" type="text/css" />
    <link rel="stylesheet" href="../css/tips.css" type="text/css" />
    <link rel="stylesheet" href="../css/syntaxhighlighter.css" type="text/css" />
    <link rel="stylesheet" href="../css/sh-theme-rdark.css" type="text/css" />
    <script type="text/javascript" src="../css/syntaxhighlighter.js" ></script>
    <script type="text/javascript" src="../css/syntaxhighlighter-brushes.js" ></script>
    <script type="text/javascript">
      SyntaxHighlighter.all()
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, minimum-scale=1.0, initial-scale=1" />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <meta name="Author" content="47Lining LLC">
    <meta name="description" content="47Lining LLC: Nucleator DevOps Acceleration Tools">
    <meta name="keywords" content="Cloud, AWS, Amazon Web Services, Nucleator, Cloud, AWS, Amazon Web Services, Cloud Platform Operations, DevOps, Ansible">
    <link rel="stylesheet" type="text/css" href="../css/screen_styles.css" />
    <link rel="stylesheet" type="text/css" href="../css/screen_layout_large.css" />
    <link rel="stylesheet" type="text/css" media="only screen and (min-width:50px) and (max-width:1000px)" href="../css/screen_layout_small.css">
    <!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58429312-2', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div class="page">
      <div class="secondaryHeader">
	<a class="secondaryLogo" href="../index.html"></a>
      </div>
      <article>
        <div id="breadcrumb-section">
          <ol id="breadcrumbs">
	    	    <li>
	      <span><a href="Nucleator-Documentation_22052969.html">Nucleator Documentation</a></span>
	    </li>
	    	    <li>
	      <span><a href="20545561.html">User&#39;s Guide</a></span>
	    </li>
	    	    <li>
	      <span><a href="How-to-Use-Nucleator_21463194.html">How to Use Nucleator</a></span>
	    </li>
	    	    <li>
	      <span><a href="Installing-and-Configuring-Nucleator_21463207.html">Installing and Configuring Nucleator</a></span>
	    </li>
	              </ol>
        </div>
        <h1>Include Additional Customers, Accounts and Cages in your siteconfig</h1>
        <div class="panel" style="border-width: 1px;"><div class="panelContent">
<span><span>How to manually extend your siteconfig by telling </span>Nucleator which AWS Accounts to use for which Customers, and which Cages and AWS Regions you want to become provisionable.</span>
</div></div><p> </p><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1455295403781 {padding: 0px;}
div.rbtoc1455295403781 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1455295403781 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1455295403781'>
<ul class='toc-indentation'>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-Extendyoursiteconfig'>Extend your siteconfig</a>
<ul class='toc-indentation'>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyCustomerDomainandAWSAccountsforthisCustomer'>Specify Customer Domain and AWS Accounts for this Customer</a></li>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyCagesforthisCustomerandmapeachtoanAWSAccountandRegion'>Specify Cages for this Customer and map each to an AWS Account and Region</a></li>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyConfigurationParametersforeachofthisCustomer&#39;sCages'>Specify Configuration Parameters for each of this Customer&#39;s Cages</a></li>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-EnterCustomer-SpecificAccountCredentials'>Enter Customer -Specific Account Credentials</a></li>
</ul>
</li>
<li><a href='#IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-Summary'>Summary</a></li>
</ul>
</div></p><p> </p>    <div class="aui-message hint shadowed information-macro">
                            <span class="aui-icon icon-hint">Icon</span>
                <div class="message-content">
                            <p>The steps in this section are optional, and are required <strong>only</strong> if you wish to manually extend the siteconfig created by the <code>nucleator siteconfig wizard</code>.</p>
                    </div>
    </div>
<h2 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-Extendyoursiteconfig">Extend your siteconfig</h2><p>Customer-specific configurations are maintained in <code>~/.nucleator/siteconfig/</code></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;">~/.nucleator/siteconfig/
    &lt;customer_name&gt;.yml # nucleator customer config for customer &lt;customer_name&gt;
	{customer}.yml # Customer configuration template </pre>
</div></div><h3 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyCustomerDomainandAWSAccountsforthisCustomer">Specify Customer Domain and AWS Accounts for this Customer</h3><p>To configure Nucleator to work with a new Customer, copy and modify the <code>{customer}.yml </code>template file to include Customer- and Account-specific information.  Name the config file  <code>{{customer_name}}</code><code>.yml</code> where <code>customer_name</code> is the name that you would like Nucleator to use for this customer.</p><p>If a customer config already exists for this Customer, just add the Account-specific information for the new Account to the customer's existing <code>{{customer_name}}</code><code>.yml</code> config file.</p><p>Within the Customer configuration template, each part of the config where Customer- or Account-specific information needs to be entered is marked with a &quot;<code>TODO&quot;</code> comment that describes the required information, for example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;">customer_domain: &quot;somedomain.com&quot; # TODO update domain name


aws_accounts:

  # TODO: add an account specification block for each new AWS Account for this customer
  test1: # TODO: update the human-readable &quot;Friendly Name&quot; of this Account.

    account_number: 123456789012 # TODO: enter Account Number for this AWS Account</pre>
</div></div><p>You can review a completed sample for an example customer at <code style="line-height: 1.4285715;"><span>~/.nucleator/siteconfig</span>/example.yml</code></p><p><span style="color: rgb(0,0,0);">When you create a new AWS Account that you want Nucleator to be able to use, you must tell Nucleator about some essential Account information.  </span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;">aws_accounts:
  
# TODO: add an account specification block for each AWS Account for this customer
  test1: # TODO: update the human-readable &quot;Friendly Name&quot; of this Account.


    account_number: 123456789012 # TODO: enter Account Number for this AWS Account

    bootstrap_region: us-west-2 # TODO: select region to use for Account-level
                                #       resources supporting best practices
                                #       (e.g. detailed billing)
 
    map_region_plus_redundant_zone_number_to_vpc_valid_az:
      # TODO: update AZ1 and AZ2 for each region to match the first two AZ&#39;s
      # capable of hosting VPC subnets in the new account.  This allows
      # Nucleator to create redundant subnets and subnet groups for
      # high-availability deployment topologies.  Note that the specific AZ&#39;s
      # available for use within VPCs may vary by Account and Region, especially
      # for Regions where AWS has a strong pre-VPC footprint like us-east-1.
      # Do not assume that the available AZs will be the same as for previous
      # Accounts.
      us-west-2:
        AZ1: us-west-2a
        AZ2: us-west-2b
      us-east-1:
        AZ1: us-east-1a
        AZ2: us-east-1c
      eu-west-1:
        AZ1: eu-west-1a
        AZ2: eu-west-1b </pre>
</div></div><p>The<strong style="line-height: 1.4285715;"> Region to AZ mapping</strong> is a mapping (<code style="line-height: 1.4285715;">&quot;map_region_plus_redundant_zone_number_to_vpc_valid_az&quot;</code>) that specifies which AZ's are valid for provisioning VPC subnets within the Account.  <span style="color: rgb(0,0,0);">This information varies from Account to Account, so you need to add this info for each new AWS Account that you create.  </span>The AZ's which are valid for provisioning VPC subnets can be determined by:</p><ul><li>selecting each AWS Region supported by Nucleator from the AWS Management Console in turn (Region pulldown in top nav bar, select each of <code style="line-height: 1.4285715;">&quot;US East (N. Virginia)</code>&quot;, <code style="line-height: 1.4285715;">&quot;US West (Oregon)</code>&quot; and <code style="line-height: 1.4285715;">&quot;EU(Ireland)</code>&quot;. </li><li>Then take note of the first two subnets that are offered for VPC subnet creation (VPC Service → Subnets → Create Subnet → Availability Zone pulldown)</li><li>Enter the noted subnets into the mapping for the corresponding AWS Region within this AWS Account's specification in the customer config.</li></ul><h3 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyCagesforthisCustomerandmapeachtoanAWSAccountandRegion">Specify Cages for this Customer and map each to an AWS Account and Region</h3><p>The Customer configuration template is pre-configured with a useful sample of Cage names that Nucleator is aware of for this Customer.  You can update the defined Cage names to suit this Customer's specific needs.  Nucleator uses these to create a an AWS Hosted Zone for each cage as part of the automated account setup process, providing a means for consistent internal- or external DNS resolution for resources provisioned within each Cage.  Nucleator will refuse to provision a Cage until you add it here.  You can always extend the list to define additional Cages later.</p><p>In the Customer configuration template, each Cage is mapped to a specified AWS Account and AWS Region where you would like this Cage to reside when it is provisioned by Nucleator.  <span style="color: rgb(0,0,0);">Nucleator currently ubiquitously supports regions where AWS supports CloudWatch logging, currently </span><code style="line-height: 1.4285715;">us-east-1</code><span style="color: rgb(0,0,0);"> (Northern VA), </span><code style="line-height: 1.4285715;">us-west-2</code><span style="color: rgb(0,0,0);"> (Oregon) and </span><code style="line-height: 1.4285715;">eu-west-1</code><span style="color: rgb(0,0,0);"> (Ireland).  For each of these Regions, <span style="color: rgb(0,0,0);">Nucleator is aware of current values for useful AMIs and other needed values that vary on a per-region basis.</span></span></p><p><span style="color: rgb(0,0,0);"><span style="color: rgb(0,0,0);">The <code>owner</code> values provided for each Cage are propagated by Nucleator and applied to an &quot;Owner&quot; tag that is applied to AWS Resources provisioned within each Cage.</span></span></p><p>Adjust these values and the set of Cage names based on the Customer's requirements: </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;"># A Cage is a set of managed AWS infrastructure that exists for a particular purpose.
# Cages can be maintained across one or more customer-specific AWS Accounts.

# TODO: modify cage names for this customer.  Consider starting with just build.
cage_names:

  # The AWS Acccount that hosts the build cage acts
  # as the source account in cross-account builds
  build:
    account: test1
    region: us-west-2
	owner: exampleUser
  ci:
    account: test1
    region: us-west-2
	owner: exampleUser
  stage:
    account: test2
    region: us-west-2
	owner: exampleRole
  prod:
    account: test2
    region: us-west-2
	owner: exampleRole</pre>
</div></div><h3 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-SpecifyConfigurationParametersforeachofthisCustomer&#39;sCages">Specify Configuration Parameters for each of this Customer's Cages</h3><p>For each Cage defined in the Customer configuration file, you will need to copy and update the <code>{customer}-{cage}.yml</code> file, also in the <code>siteconfig</code> directory.  These files provide configuration details for each Cage.  In each of the new files, you will need to update the values for these fields:</p><dl class="simpleindent">
  <dt><pre xmlns="http://www.w3.org/1999/xhtml" style="margin-left: 30.0px;" xml:space="preserve">network_toplogy:<br clear="none"/>first8: 172<br clear="none"/>second8: 32</pre></dt><dd><p xmlns="http://www.w3.org/1999/xhtml" style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">These variables define the IP address space used by the AWS VPC within this Cage.  Typically each Cage will consume address space within those ranges specified by <a href="https://tools.ietf.org/html/rfc1918" class="external-link" rel="nofollow" shape="rect">RFC 1918 - Address Allocation for Private Internets</a>.</span></p><p xmlns="http://www.w3.org/1999/xhtml" style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">To make things simple, the <code>network_topology</code> relies on two convenience variables:</span></p><ul xmlns="http://www.w3.org/1999/xhtml"><li style="list-style-type: none;background-image: none;"><ul><li><span style="color: rgb(0,0,0);"><code>first8</code> – Specifies the value for the first eight bits of the CIDR for the VPC that will be provisioned for this cage.  The value specified in the default Cage configuration is <code>172</code>.  If you use the <code>10.*</code> address space for your networks, you can make that update here.</span></li><li><span style="color: rgb(0,0,0);"><code>second8</code> – Specifies the value for the second eight bits of the CIDR for the VPC that will be provisioned for this cage.  The value specified in the default Cage configuration is <code>32</code>, so as to not conflict with the default AWS VPC and allow for easy incrementing to accomodate additional Cages.</span></li></ul></li></ul><p xmlns="http://www.w3.org/1999/xhtml" style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);">You should update these values so that the IP Address of each of your cages in non-overlapping.  This will allow each of the provisioned VPC's to be consolidated into a single address space via VPN, if needed in the future.  In most cases simply incrementing the value specified for <code>second8</code> for each Cage that you add is sufficient.</span></p><p xmlns="http://www.w3.org/1999/xhtml" style="margin-left: 30.0px;"><span style="color: rgb(0,0,0);"><span>Nucleator Cages default to allocating a /16 CIDR, i.e. 172.32.*.*, 172.33.*.* etc.</span></span></p><p xmlns="http://www.w3.org/1999/xhtml"><span style="color: rgb(0,0,0);"><br clear="none"/></span></p></dd></dl><h3 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-EnterCustomer-SpecificAccountCredentials">Enter Customer -Specific Account Credentials</h3><p>Customer credentials are maintained in <code>~/.nucleator/ </code>in files named <code>{customer}-credentials.yml</code>, for example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;">~/.nucleator/
    47lining-credentials.yml
    othercustomer-credentials.yml </pre>
</div></div><p> </p><p>The <code>nucleator init</code> command creates a template for a new customer in <code>{customer}-credentials.yml </code>in the above directory.</p><p>Nucleator supports the use of multiple AWS Accounts per customer, and provides convenience facilities to help you to set up each of these accounts.  The customer credentials file enables you to provide Nucleator with IAM credentials for each account used by a customer.  Nucleator uses these credentials to provision IAM Roles within the Account (see below), after which the credentials are no longer required.  IAM User credentials should not be maintained in git, this is why customer credentials are provided in a distinct file in <code>~/.nucleator</code>, rather than in the <code>siteconfig</code>.</p><p>Create a customer credentials file for your first Nucleator customer by copying the template, and modify that file to include the account-specific information for each account the customer has.  Name the config file  <code>{{customer_name}}-credentials</code><code>.yml</code> where <code>customer_name</code> is the name that you would like Nucleator to use for this customer.  There should be access and secret keys for each Account named in the configuration step above:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="theme: RDark; brush: bash; gutter: false" style="font-size:12px;">aws_account_access_keys:
 
  test1: # TODO - provide credentials for each AWS Account for which you would like Nucleator to assist with account setup
 
    aws_access_key_id: &lt;provide IAM User credentials: access key ID&gt;
    aws_secret_access_key: &lt;provide IAM User credentials: secret access key&gt;

</pre>
</div></div><p>Note: the credentials above are not valid.  You need to replace them with values from your own Account.</p><h2 id="IncludeAdditionalCustomers,AccountsandCagesinyoursiteconfig-Summary">Summary</h2><p>Here's a summary of the Customer- and Account-specific information that Nucleator needs to be in place:</p>    <div class="aui-message success shadowed information-macro">
                    <p class="title">customer configuration file</p>
                            <span class="aui-icon icon-success">Icon</span>
                <div class="message-content">
                            <p><strong><code><code>{{customer_name}}.yml</code></code></strong></p><p style="margin-left: 30.0px;">Nucleator expects to find each customer's config in <code>{{customer_name}}.yml</code> within the <code>siteconfig</code> directory accessible at <code>~/.nucleator/siteconfig/</code></p><ul><li><strong><code>customer_name</code></strong> – Nucleator expects to find each customer's config in <code>{{customer_name}}.yml</code> within the <code>vars</code> directory of the <code>config</code> Ansible role.</li><li><strong><code>customer_domain</code></strong> – Nucleator sets up external DNS to each of a customer's configured &quot;Cages&quot; (each, an independent AWS VPC).  All Cages for a customer are configured as subdomains of the <code>customer_domain </code>specified in the customer config.</li><li><strong><code>cage_names</code></strong> – Nucleator can set up a VPC and defined deployment targets for each of a list of &quot;Cages&quot; that are specified in the customer config.  You can add a list of Cage names that Nucleator will respect.</li><li><strong><code>aws_accounts</code></strong> – Nucleator can work with multiple AWS accounts for each customer.  These are specified in <code>aws_accounts</code> in the customer config.  Each specified AWS Account includes:<ul><li><p>Friendly <strong><code>account_name</code></strong> – this is a name for the Account that is readable by humans.  It is used elsewhere in Nucleator config and in Jenkins pulldowns that are set up by Nucleator, where choices among AWS Accounts must occur.</p></li><li><strong><code>account_number</code></strong> - this is the unique twelve-digit Account Number provided by AWS for this AWS Account. The account number can be found by selecting the &quot;Support&quot; | &quot;Support Center&quot; pulldown from your AWS console. Your Account number will appear at the upper right of the Support Center page.</li><li><strong><code>bootstrap_region</code></strong> - this is the AWS Region where Nucleator will create Amazon resources within this Account that it needs to support the creation of Cages and Stacksets.</li><li><strong><span><code>map_region_plus_redundant_zone_number_to_vpc_valid_az</code> </span></strong> – Region to Availability Zone Mapping that specifies which AZ's are valid for provisioning VPC subnets within the Account.</li></ul></li></ul>
                    </div>
    </div>
    <div class="aui-message success shadowed information-macro">
                    <p class="title">cage configuration file</p>
                            <span class="aui-icon icon-success">Icon</span>
                <div class="message-content">
                            <p><strong><code><code>{{customer_name}}-{{cage_name}}.yml</code></code></strong></p><p style="margin-left: 30.0px;">Nucleator expects to find config parameters for each Cage defined for each customer in <code>{{customer_name}}-{{cage_name}}.yml</code> within the <code>siteconfig</code> directory accessible at <code>~/.nucleator/siteconfig/</code></p><ul><li><strong><code>first8</code></strong> – The first eight bits for the VPC associated with this cage. Nucleator users will typically use either <code>172</code> (the default in the Cage configuration template) or <code>10</code>.</li><li><strong><code>second8</code></strong> – The second eight bits for the VPC associated with this cage. If you do not have other driving requirements, you can use the default of <code>32</code> specified in the Cage configuration template, and increment by one for each subsequently defined Cage.</li><li><strong><code>network_topology</code></strong> – If needed, you can further refine the network topology used by this Cage by adjusting additional values from this Cage configuration file.</li></ul>
                    </div>
    </div>
    <div class="aui-message success shadowed information-macro">
                    <p class="title">cage certificate file</p>
                            <span class="aui-icon icon-success">Icon</span>
                <div class="message-content">
                            <p><strong><code>{{customer_name}}-{{cage_name}}.crt</code></strong></p><p style="margin-left: 30.0px;">Nucleator site wizard creates a self-signed certificate file for you for each cage in the event you want to use SSL connections to your web servers and/or the builder stackset. If you need to create one of these files manually, use the instructions on the next page - <a href="Provide-SSL-Certificates-for-Your-Defined-Customers-and-Cages_23429204.html">Provide SSL Certificates for Your Defined Customers and Cages</a>.</p>
                    </div>
    </div>
    <div class="aui-message success shadowed information-macro">
                    <p class="title">customer credentials file</p>
                            <span class="aui-icon icon-success">Icon</span>
                <div class="message-content">
                            <p><strong><code><code>{{customer_name}}-credentials.yml</code></code></strong></p><p style="margin-left: 30.0px;">Nucleator expects to find AWS Credentials for each Customer in <code>{{customer_name}}-credentials.yml</code> within <code>~/.nucleator/</code></p><p style="margin-left: 30.0px;">These are maintained distinct from the <code>siteconfig</code> as a security best practice, and are only required to accomodate creation of Nucleator IAM Roles.  For each AWS Account Nucleator expects:</p><ul><li><strong><code>aws_access_key_id</code></strong> – IAM User credentials for an IAM User with sufficient permissions to accomodate creation of Nucleator IAM Roles</li><li><strong><code>aws_secret_access_key</code></strong> – IAM User credentials for an IAM User with sufficient permissions to accomodate creation of Nucleator IAM Roles</li></ul>
                    </div>
    </div>
<p> </p><p><span><span>Next: <a href="Provide-SSL-Certificates-for-Your-Defined-Customers-and-Cages_23429204.html">Provide SSL Certificates for Your Defined Customers and Cages</a><br /></span></span></p>
      </article>
      <div class="clear-fix"></div>
      <div class="secondaryNav">
	<a href="../installation.html">Installation</a>
	<a href="index.html">Documentation</a>
	<a href="../releases.html">Releases</a>
	<a href="../license.html">License</a>
	<a href="../community.html">Community</a>
      </div>
      <footer>
	&copy; Copyright 2016, <a href="http://www.47lining.com" target="_blank">47Lining, LLC</a>
      </footer>
    </div>   </body>
</html>
